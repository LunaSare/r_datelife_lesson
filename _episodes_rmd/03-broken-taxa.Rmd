---
source: Rmd
title: 'Dealing with "broken" and "invalid" taxa'
teaching: 5
exercises: 5
questions:
- "How do I detect a broken taxon?"
objectives:
- "Know what functions are available to get taxon information"
- "Understand outputs from those functions"
keypoints:
- "taxonomic tree..."
---
```{r, eval = TRUE, echo = FALSE}
source("../bin/chunk-options.R")
my_taxa <- c("amphibians", "canis", "felis", "delphinidae", "spheniscidae")
resolved_names <- rotl::tnrs_match_names(my_taxa)
rownames(resolved_names) <- resolved_names$unique_name
```
We say that a taxon is "broken" when its _ott id_ is not assigned to a node in the synthetic tree.
In practice, this means the the _ott id_ is **not** in the tree.
This is the reason why we get an error when we try to get a synthetic subtree using that _ott id_.

There is a way to find out that a group is "broken" before trying to get the subtree and getting an error.
```{r, eval = TRUE, results= 'hide', warning= FALSE, error = TRUE}
rotl::is_in_tree(resolved_names["Canis",]$ott_id)
```

To extract a subtree of a "broken" taxon, we have some options.

### a) Get a subtree using the _node id_ instead of the _ott id_

`rotl` has a function that gets for you all info from the node containing a taxon. That includes the actual _node id_.
```{r, eval = TRUE, warning= FALSE, error = TRUE}
canis_node_info <- rotl::tol_node_info(resolved_names["Canis",]$ott_id)
canis_node_info
```

> #### **Extra: tol_lineage()**
>
> `tol_lineage()` gets information from all ancestral nodes from a given _node id_.
>
> Setting up include_lineage = TRUE in `tol_node_info()` will call this function and include that information along the output that can be accessed with `tax_lineage()`.
{: .testimonial}

> #### **Extra: tol_mrca()**
>
> `tol_mrca()` gets the mrca of a group of _ott ids_.
>
> Can we use it to get the mrca of _Canis_?
{: .testimonial}


The _node_ that contains _Canis_ is "`r canis_node_info$node_id`". We can use it to get a subtree with `tol_subtree()`.

```{r, eval = TRUE, results= 'hide', warning= FALSE, error = TRUE}
canis_node_subtree <- rotl::tol_subtree(node_id = canis_node_info$node_id)
```
```{r, eval = TRUE, results= 'asis', warning= FALSE, error = TRUE, fig.height = 9}
ape::plot.phylo(canis_node_subtree, cex = 0.5)
```

Nice! We got a subtree of 85 tips, containing all descendants from the node that also contains _Canis_.

This includes species assigned to genera other than _Canis_.

It might seem non phylogenetic, but what if I _really, really_ need a tree containing species within the genus _Canis_ only?

### b) Get an induced subtree of taxonomic children

We can get the _ott ids_ of the taxonomic children of our taxon of interest and use the function `tol_induced_subtree()`.

First, get the taxonomic children.
```{r, eval = TRUE, results= 'hide', warning= FALSE, error = TRUE}
canis_taxonomy <- rotl::taxonomy_subtree(resolved_names["Canis",]$ott_id)
```
```{r, eval = TRUE, warning= FALSE, error = TRUE}
canis_taxonomy
```
Now, extract the _ott ids_.
```{r, eval = TRUE, results= 'hide', warning= FALSE, error = TRUE}
canis_taxonomy_ott_ids <- datelife::extract_ott_ids(x = canis_taxonomy$tip_label)
```
Try to get an induced subtree of _Canis_ taxonomic children.

```{r, eval = TRUE, results = 'hide', warning= FALSE, error = TRUE}
canis_taxonomy_subtree <- rotl::tol_induced_subtree(canis_taxonomy_ott_ids)
```
It is often not possible to get an induced subtree of all taxonomic children from a taxon,
because some of them will not make it to the synthetic tree.

To verify which ones are giving us trouble, we can use the function `is_in_tree()` again.
```{r, eval = TRUE, warning= FALSE, error = TRUE, results = 'hide'}
canis_in_tree <- sapply(canis_taxonomy_ott_ids, rotl::is_in_tree) # logical vector
canis_taxonomy_ott_ids_intree <- canis_taxonomy_ott_ids[canis_in_tree] # extract ott ids in tree
```

Now get the tree.
```{r, eval = TRUE, results = 'hide', warning= FALSE, error = TRUE}
canis_taxonomy_subtree <- rotl::tol_induced_subtree(canis_taxonomy_ott_ids_intree)
```
Plot it.
```{r, eval = TRUE, results= 'asis', warning= FALSE, error = TRUE, fig.height = 6}
ape::plot.phylo(canis_taxonomy_subtree, cex = 0.5)
```

There! We have a synthetic subtree (derived from phylogenetic information) containing only the taxonomic children of _Canis_.
