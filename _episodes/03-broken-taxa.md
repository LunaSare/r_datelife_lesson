---
# Please do not edit this file directly; it is auto generated.
# Instead, please edit 03-broken-taxa.md in _episodes_rmd/
source: Rmd
title: 'Dealing with "broken" and "invalid" taxa'
teaching: 5
exercises: 5
questions:
- "What is a broken taxon?"
- "How do I detect it?"
objectives:
- "Get to know the functions that interact with nodes in the synthetic OpenTree."
- "Understand outputs from those functions."
keypoints:
- "It is not possible to get a subtre from an OTT id that is not in the synthetic tree."
- "OTT ids and node ids allow us to interact with the synthetic OpenTree."
---


<br/>
<br/>

We say that a taxon is _"broken"_ when its OTT id is not assigned to any node in the OpenTree synthetic tree.
As mentioned before, this happens when the OTT id belongs to a taxon that is not monophyletic in the current version of the synthetic OpenTree.
This is the reason why we get an error when we try to get an OpenTree synthetic subtree including the OTT id of the genus _Canis_ --it is **not monophyletic** in the tree.


There is a way to find out that a group is "broken" before trying to get the subtree and getting an error.

~~~
rotl::is_in_tree(resolved_names["Canis",]$ott_id)
~~~
{: .language-r}



~~~
canis 
FALSE 
~~~
{: .output}

Indeed, our _Canis_ is **not** in the synthetic OpenTree. To extract a subtree of a "broken" taxon, we have some options. But we will focus on one.

### Getting the MRCA of a taxon

The function `tol_node_info()` gets for you all relevant information of the node that is the ancestor or MRCA of a taxon. That also includes the actual node id.

~~~
canis_node_info <- rotl::tol_node_info(resolved_names["Canis",]$ott_id)
~~~
{: .language-r}



~~~
Error: Only atomic vectors of length 1 or data frames with 1 row can be unboxed.
~~~
{: .error}



~~~
canis_node_info
~~~
{: .language-r}



~~~

OpenTree node.

Node id: mrcaott47497ott110766
Number of terminal descendants: 85
Is taxon: FALSE
~~~
{: .output}
Let's explore the class of the output.


~~~
class(canis_node_info)
~~~
{: .language-r}



~~~
[1] "tol_node" "list"    
~~~
{: .output}

<br/>

So we have an object of class 'list' and 'tol_node'. When we printed it, we got some
information. But we do not know how much information might not be "printed" to screen.

<br/>

Let's use the functions `str()` or `ls()` to check out the data strcture of our 'tol_node' object.


~~~
str(canis_node_info)
~~~
{: .language-r}



~~~
List of 8
 $ node_id      : chr "mrcaott47497ott110766"
 $ num_tips     : int 85
 $ query        : chr "ott372706"
 $ resolves     :List of 1
  ..$ pg_2812@tree6545: chr "node1135827"
 $ source_id_map:List of 5
  ..$ ot_278@tree1    :List of 3
  .. ..$ git_sha : chr ""
  .. ..$ study_id: chr "ot_278"
  .. ..$ tree_id : chr "tree1"
  ..$ ot_328@tree1    :List of 3
  .. ..$ git_sha : chr ""
  .. ..$ study_id: chr "ot_328"
  .. ..$ tree_id : chr "tree1"
  ..$ pg_1428@tree2855:List of 3
  .. ..$ git_sha : chr ""
  .. ..$ study_id: chr "pg_1428"
  .. ..$ tree_id : chr "tree2855"
  ..$ pg_2647@tree6169:List of 3
  .. ..$ git_sha : chr ""
  .. ..$ study_id: chr "pg_2647"
  .. ..$ tree_id : chr "tree6169"
  ..$ pg_2812@tree6545:List of 3
  .. ..$ git_sha : chr ""
  .. ..$ study_id: chr "pg_2812"
  .. ..$ tree_id : chr "tree6545"
 $ supported_by :List of 2
  ..$ ot_278@tree1: chr "node233"
  ..$ ot_328@tree1: chr "node495"
 $ synth_id     : chr "opentree13.4"
 $ terminal     :List of 2
  ..$ pg_1428@tree2855: chr "node610132"
  ..$ pg_2647@tree6169: chr "ott247333"
 - attr(*, "class")= chr [1:2] "tol_node" "list"
~~~
{: .output}

This is telling us that `tol_node_info()` extracted 8 different pieces of information from my node.
Right now we are only interested in the node id. Where do you think we can find it?

<br/>

> ## Hands on! Get the node id of _Canis_ MRCA
>
> Extract it from your `canis_node_info` object and call it `canis_node_id`.
>
> 
> ~~~
> canis_node_id <- canis_node_info$node_id
> ~~~
> {: .language-r}
{: .challenge}

<!-- > > ## **Extra: tol_lineage()**
> >
> > `tol_lineage()` gets information from all ancestral nodes from a given node id.
> >
> > Setting up include_lineage = TRUE in `tol_node_info()` will call this function and include that information along the output that can be accessed with `tax_lineage()`.
> {: .solution}
{: .testimonial} -->
<br/>

> > ## Pro tip 3.1: Get the node id of the MRCA of a group of OTT ids
> >
> > Sometimes you want the MRCA of a bunch of lineages. The function `tol_mrca()` gets the node of the MRCA of a group of OTT ids.
> >
> > Can you use it to get the mrca of _Canis_?
> {: .solution}
{: .testimonial}


The node that contains _Canis_ is **mrcaott47497ott110766**.

<br/>

### Getting a subtree using a node id instead of the taxon OTT id

Now that we have a node id, we can use it to get a subtree with `tol_subtree()`, using the argument `node_id`.


~~~
canis_node_subtree <- rotl::tol_subtree(node_id = canis_node_id)
canis_node_subtree
~~~
{: .language-r}



~~~

Phylogenetic tree with 85 tips and 28 internal nodes.

Tip labels:
  Canis_lupus_pallipes_ott47497, Canis_lupus_chanco_ott47500, Canis_lupus_baileyi_ott67371, Canis_lupus_laniger_ott80830, Canis_lupus_hattai_ott83897, Canis_lupus_desertorum_ott234374, ...
Node labels:
  , , , , , , ...

Unrooted; no branch lengths.
~~~
{: .output}

~~~
ape::plot.phylo(canis_node_subtree, cex = 1.2)
~~~
{: .language-r}

<img src="../fig/rmd-unnamed-chunk-8-1.png" title="plot of chunk unnamed-chunk-8" alt="plot of chunk unnamed-chunk-8" width="612" style="display: block; margin: auto;" />

Nice! We got a subtree of 85 tips, containing all descendants from the node that also contains _Canis_.

If you explore the taxon names at the tip, you will notice that this includes species assigned to genera other than _Canis_.

Now, what if I want a subtree of certain taxonomic ranks withing my group? Go to the next episode and find out how you can do this!


> > ## Pro Tip 3.2: Get an induced subtree of taxonomic children
> >
> > What if I _really, really_ need a tree containing species within the genus _Canis_ only, excluding everything that does not belong to the genus taxonomically, even if it does phylogenetically?
> >
> > We can get the OTT ids of the taxonomic children of our taxon of interest and use the function `tol_induced_subtree()`.
> >
> >
> > First, we will get the taxonomic children.
> > 
> > ~~~
> > canis_taxonomy <- rotl::taxonomy_subtree(resolved_names["Canis",]$ott_id)
> > ~~~
> > {: .language-r}
> > 
> > 
> > 
> > ~~~
> > Error: Only atomic vectors of length 1 or data frames with 1 row can be unboxed.
> > ~~~
> > {: .error}
> > 
> > ~~~
> > canis_taxonomy
> > ~~~
> > {: .language-r}
> > 
> > 
> > 
> > ~~~
> > Error in eval(expr, envir, enclos): object 'canis_taxonomy' not found
> > ~~~
> > {: .error}
> > Now, extract the OTT ids.
> > 
> > ~~~
> > canis_taxonomy_ott_ids <- datelife::extract_ott_ids(x = canis_taxonomy$tip_label)
> > ~~~
> > {: .language-r}
> > 
> > 
> > 
> > ~~~
> > Error in datelife::extract_ott_ids(x = canis_taxonomy$tip_label): object 'canis_taxonomy' not found
> > ~~~
> > {: .error}
> > Try to get an induced subtree of _Canis_ taxonomic children.
> >
> > 
> > ~~~
> > canis_taxonomy_subtree <- rotl::tol_induced_subtree(canis_taxonomy_ott_ids)
> > ~~~
> > {: .language-r}
> > 
> > 
> > 
> > ~~~
> > Error in .tol_induced_subtree(ott_ids = ott_ids, node_ids = node_ids, : object 'canis_taxonomy_ott_ids' not found
> > ~~~
> > {: .error}
> > It is often not possible to get an induced subtree of all taxonomic children from a taxon,
> > because some of them will not make it to the synthetic tree.
> >
> > To verify which ones are giving us trouble, we can use the function `is_in_tree()` again.
> > 
> > ~~~
> > canis_in_tree <- sapply(canis_taxonomy_ott_ids, rotl::is_in_tree) # logical vector
> > ~~~
> > {: .language-r}
> > 
> > 
> > 
> > ~~~
> > Error in lapply(X = X, FUN = FUN, ...): object 'canis_taxonomy_ott_ids' not found
> > ~~~
> > {: .error}
> > 
> > 
> > 
> > ~~~
> > canis_taxonomy_ott_ids_intree <- canis_taxonomy_ott_ids[canis_in_tree] # extract ott ids in tree
> > ~~~
> > {: .language-r}
> > 
> > 
> > 
> > ~~~
> > Error in eval(expr, envir, enclos): object 'canis_taxonomy_ott_ids' not found
> > ~~~
> > {: .error}
> >
> > Now get the tree.
> > 
> > ~~~
> > canis_taxonomy_subtree <- rotl::tol_induced_subtree(canis_taxonomy_ott_ids_intree)
> > ~~~
> > {: .language-r}
> > 
> > 
> > 
> > ~~~
> > Error in .tol_induced_subtree(ott_ids = ott_ids, node_ids = node_ids, : object 'canis_taxonomy_ott_ids_intree' not found
> > ~~~
> > {: .error}
> > Plot it.
> > 
> > ~~~
> > ape::plot.phylo(canis_taxonomy_subtree, cex = 1.2)
> > ~~~
> > {: .language-r}
> > 
> > 
> > 
> > ~~~
> > Error in ape::plot.phylo(canis_taxonomy_subtree, cex = 1.2): object 'canis_taxonomy_subtree' not found
> > ~~~
> > {: .error}
> >
> > There! We have a synthetic subtree (derived from phylogenetic information) containing only the taxonomic children of _Canis_.
> {: .solution}
{: .testimonial}

<br/>
